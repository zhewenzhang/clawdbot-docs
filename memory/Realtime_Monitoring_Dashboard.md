# å®æ—¶ç›‘æ§é¢æ¿å¼€å‘ï¼šæ•°æ®æµ/é¢„è­¦æœºåˆ¶/Dashboard
> å­¦ä¹ ç¬”è®° | ç‰ˆæœ¬ï¼š1.0 | 2026-02-03

---

## ä¸€ã€ç›‘æ§é¢æ¿æ¦‚è¿°

### 1.1 ç›‘æ§è¦ç´ 

```
ç›‘æ§é¢æ¿è¦ç´ 

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å®æ—¶ç›‘æ§é¢æ¿                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     è¡Œæƒ…ç›‘æ§    â”‚     ç»„åˆç›‘æ§    â”‚     é¢„è­¦ç›‘æ§        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ å®æ—¶ä»·æ ¼      â”‚ â€¢ ç»„åˆä»·å€¼      â”‚ â€¢ ä»·æ ¼é¢„è­¦          â”‚
â”‚ â€¢ æ¶¨è·Œå¹…        â”‚ â€¢ æ”¶ç›Šç‡        â”‚ â€¢ æ¶¨è·Œå¹…é¢„è­¦        â”‚
â”‚ â€¢ æˆäº¤é‡        â”‚ â€¢ æŒä»“æ¯”ä¾‹      â”‚ â€¢ æ¶ˆæ¯æ¨é€          â”‚
â”‚ â€¢ K çº¿å›¾        â”‚ â€¢ é£é™©æŒ‡æ ‡      â”‚ â€¢ é‚®ä»¶/çŸ­ä¿¡        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ¶æ„

```
ç›‘æ§é¢æ¿æ¶æ„

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å‰ç«¯å±•ç¤ºå±‚                            â”‚
â”‚              (Streamlit/Dash/Plotly)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å¤„ç†å±‚                            â”‚
â”‚                 (Pandas/NumPy)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®è·å–å±‚                            â”‚
â”‚              (akshare/è¡Œæƒ… API)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   é¢„è­¦è§¦å‘å±‚                            â”‚
â”‚               (æ¡ä»¶åˆ¤æ–­/æ¶ˆæ¯æ¨é€)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€Streamlit Dashboard å®æˆ˜

### 2.1 Streamlit åŸºç¡€

**å®‰è£… Streamlit**

```bash
pip install streamlit
```

**è¿è¡Œ Dashboard**

```bash
streamlit run dashboard.py
```

**åŸºç¡€ç»“æ„**

```python
import streamlit as st
import pandas as pd
import numpy as np

# è®¾ç½®é¡µé¢
st.set_page_config(page_title="æŠ•èµ„ç›‘æ§é¢æ¿", layout="wide")

# æ ‡é¢˜
st.title("ğŸ¯ æŠ•èµ„ç›‘æ§é¢æ¿")
st.markdown("---")

# ä¾§è¾¹æ 
st.sidebar.header("è®¾ç½®")
symbol = st.sidebar.selectbox("é€‰æ‹©è‚¡ç¥¨", ["600519", "000001", "600036"])
```

### 2.2 å®æ—¶è¡Œæƒ…ç›‘æ§

```python
import streamlit as st
import pandas as pd
import akshare as ak
import time
from datetime import datetime

# è®¾ç½®é¡µé¢
st.set_page_config(page_title="è¡Œæƒ…ç›‘æ§", layout="wide")

st.title("ğŸ“ˆ å®æ—¶è¡Œæƒ…ç›‘æ§")

# è‚¡ç¥¨åˆ—è¡¨
stocks = {
    "è´µå·èŒ…å°": "600519",
    "å¹³å®‰é“¶è¡Œ": "000001",
    "æ‹›å•†é“¶è¡Œ": "600036",
    "å°ç§¯ç”µ": "TSM"
}

# é€‰æ‹©è‚¡ç¥¨
col1, col2 = st.columns([1, 3])
with col1:
    selected_stock = st.selectbox("é€‰æ‹©è‚¡ç¥¨", list(stocks.keys()))
    symbol = stocks[selected_stock]
    
    # åˆ·æ–°é—´éš”
    refresh_rate = st.slider("åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰", 5, 60, 10)

with col2:
    # è·å–å®æ—¶æ•°æ®
    if symbol == "TSM":
        import yfinance as yf
        data = yf.Ticker(symbol)
        df = data.history(period="5d")
        latest_price = df['Close'].iloc[-1]
        prev_close = df['Open'].iloc[0]
        change = (latest_price - prev_close) / prev_close * 100
        volume = df['Volume'].iloc[-1]
    else:
        df = ak.stock_zh_a_spot_em()
        stock_data = df[df['ä»£ç '] == symbol]
        if len(stock_data) > 0:
            latest_price = float(stock_data['æœ€æ–°ä»·'].iloc[0])
            prev_close = float(stock_data['æ˜¨æ”¶'].iloc[0])
            change = float(stock_data['æ¶¨è·Œå¹…'].iloc[0])
            volume = float(stock_data['æˆäº¤é‡'].iloc[0])

    # æ˜¾ç¤ºå…³é”®æŒ‡æ ‡
    m1, m2, m3 = st.columns(3)
    m1.metric("æœ€æ–°ä»·", f"${latest_price:.2f}" if symbol == "TSM" else f"Â¥{latest_price:.2f}", 
              f"{change:.2f}%")
    m2.metric("æ¶¨è·Œé¢", f"{latest_price - prev_close:.2f}")
    m3.metric("æˆäº¤é‡", f"{volume/1e6:.2f}M")

# è‡ªåŠ¨åˆ·æ–°
if st.button("åˆ·æ–°æ•°æ®"):
    st.rerun()

# è‡ªåŠ¨åˆ·æ–°è„šæœ¬
if refresh_rate > 0:
    time.sleep(refresh_rate)
    st.rerun()
```

### 2.3 K çº¿å›¾ç›‘æ§

```python
import streamlit as st
import pandas as pd
import akshare as ak
import plotly.graph_objects as go
from datetime import datetime, timedelta

def get_kline_data(symbol, period="daily", days=90):
    end_date = datetime.now().strftime('%Y%m%d')
    start_date = (datetime.now() - timedelta(days=days)).strftime('%Y%m%d')
    
    if symbol == "TSM":
        import yfinance as yf
        data = yf.Ticker(symbol)
        df = data.history(start=start_date, end=end_date)
    else:
        df = ak.stock_zh_a_hist(symbol=symbol, period=period, 
                                start_date=start_date, end_date=end_date)
    
    return df

# K çº¿å›¾
st.title("ğŸ“Š K çº¿å›¾ç›‘æ§")

# é€‰æ‹©è‚¡ç¥¨å’Œæ—¶é—´å‘¨æœŸ
col1, col2, col3 = st.columns(3)
with col1:
    symbol = st.selectbox("è‚¡ç¥¨", ["600519", "000001", "600036"])
with col2:
    period = st.selectbox("å‘¨æœŸ", ["æ—¥çº¿", "å‘¨çº¿", "æœˆçº¿"])
with col3:
    days = st.slider("æ˜¾ç¤ºå¤©æ•°", 30, 365, 90)

# è·å–æ•°æ®
period_map = {"æ—¥çº¿": "daily", "å‘¨çº¿": "weekly", "æœˆçº¿": "monthly"}
df = get_kline_data(symbol, period_map[period], days)

if len(df) > 0:
    # å¤„ç†æ—¥æœŸ
    if symbol == "TSM":
        df['æ—¥æœŸ'] = df.index
    else:
        df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'])
    
    # K çº¿å›¾
    fig = go.Figure(data=[go.Candlestick(
        x=df['æ—¥æœŸ'],
        open=df['å¼€ç›˜'],
        high=df['æœ€é«˜'],
        low=df['æœ€ä½'],
        close=df['æ”¶ç›˜'],
        increasing_line_color='red',
        decreasing_line_color='green',
        name='K çº¿'
    )])
    
    # æ·»åŠ å‡çº¿
    df['MA5'] = df['æ”¶ç›˜'].rolling(5).mean()
    df['MA20'] = df['æ”¶ç›˜'].rolling(20).mean()
    df['MA60'] = df['æ”¶ç›˜'].rolling(60).mean()
    
    fig.add_trace(go.Scatter(x=df['æ—¥æœŸ'], y=df['MA5'], name='MA5', line=dict(color='orange', width=1)))
    fig.add_trace(go.Scatter(x=df['æ—¥æœŸ'], y=df['MA20'], name='MA20', line=dict(color='blue', width=1)))
    fig.add_trace(go.Scatter(x=df['æ—¥æœŸ'], y=df['MA60'], name='MA60', line=dict(color='purple', width=1)))
    
    fig.update_layout(
        title=f"{symbol} K çº¿å›¾",
        xaxis_title="æ—¥æœŸ",
        yaxis_title="ä»·æ ¼",
        xaxis_rangeslider_visible=False,
        height=600
    )
    
    st.plotly_chart(fig, use_container_width=True)
```

### 2.4 ç»„åˆç›‘æ§

```python
import streamlit as st
import pandas as pd
import akshare as ak
import numpy as np

# è®¾ç½®é¡µé¢
st.set_page_config(page_title="ç»„åˆç›‘æ§", layout="wide")

st.title("ğŸ’¼ ç»„åˆç›‘æ§")

# å®šä¹‰ç»„åˆ
portfolio = {
    "è´µå·èŒ…å°": {"shares": 100, "cost": 1500},
    "å¹³å®‰é“¶è¡Œ": {"shares": 1000, "cost": 10},
    "æ‹›å•†é“¶è¡Œ": {"shares": 500, "cost": 35},
    "å°ç§¯ç”µ": {"shares": 50, "cost": 80}
}

# è·å–å®æ—¶ä»·æ ¼
current_prices = {}
for name, info in portfolio.items():
    if name == "å°ç§¯ç”µ":
        import yfinance as yf
        data = yf.Ticker("TSM")
        df = data.history(period="1d")
        current_prices[name] = df['Close'].iloc[-1]
    else:
        symbol_map = {"è´µå·èŒ…å°": "600519", "å¹³å®‰é“¶è¡Œ": "000001", "æ‹›å•†é“¶è¡Œ": "600036"}
        df = ak.stock_zh_a_spot_em()
        stock_data = df[df['ä»£ç '] == symbol_map[name]]
        if len(stock_data) > 0:
            current_prices[name] = float(stock_data['æœ€æ–°ä»·'].iloc[0])

# è®¡ç®—ç»„åˆä»·å€¼
total_value = 0
total_cost = 0
portfolio_data = []

for name, info in portfolio.items():
    if name in current_prices:
        current_price = current_prices[name]
        cost = info['shares'] * info['cost']
        value = info['shares'] * current_price
        pnl = value - cost
        pnl_pct = (current_price - info['cost']) / info['cost'] * 100
        weight = value / sum(info['shares'] * current_prices.get(name, 0) for name in portfolio.keys() if name in current_prices)
        
        total_value += value
        total_cost += cost
        
        portfolio_data.append({
            "è‚¡ç¥¨": name,
            "æŒè‚¡æ•°": info['shares'],
            "æˆæœ¬ä»·": info['cost'],
            "å½“å‰ä»·": current_price,
            "å¸‚å€¼": value,
            "ç›ˆäº": pnl,
            "ç›ˆäº%": pnl_pct,
            "å æ¯”": weight * 100
        })

# æ˜¾ç¤ºç»„åˆæ¦‚è§ˆ
m1, m2, m3, m4 = st.columns(4)
m1.metric("æ€»å¸‚å€¼", f"Â¥{total_value:,.0f}")
m2.metric("æ€»æˆæœ¬", f"Â¥{total_cost:,.0f}")
m3.metric("æ€»ç›ˆäº", f"Â¥{total_value - total_cost:,.0f}")
m4.metric("æ”¶ç›Šç‡", f"{(total_value - total_cost) / total_cost * 100:.2f}%")

# æ˜¾ç¤ºæŒä»“è¯¦æƒ…
portfolio_df = pd.DataFrame(portfolio_data)
st.dataframe(
    portfolio_df.style.format({
        "æˆæœ¬ä»·": "Â¥{:.2f}",
        "å½“å‰ä»·": "Â¥{:.2f}",
        "å¸‚å€¼": "Â¥{:.0f}",
        "ç›ˆäº": "Â¥{:.0f}",
        "ç›ˆäº%": "{:.2f}%",
        "å æ¯”": "{:.1f}%"
    }).background_gradient(subset=['ç›ˆäº%'], cmap='RdYlGn'),
    use_container_width=True
)

# é¥¼å›¾
import plotly.express as px
fig = px.pie(portfolio_df, values='å¸‚å€¼', names='è‚¡ç¥¨', title='æŒä»“å æ¯”')
st.plotly_chart(fig, use_container_width=True)
```

---

## ä¸‰ã€é¢„è­¦æœºåˆ¶

### 3.1 é¢„è­¦ç±»å®ç°

```python
import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime

class PriceAlert:
    def __init__(self):
        self.alerts = []
        
    def add_alert(self, symbol, alert_type, price, message=""):
        """æ·»åŠ é¢„è­¦"""
        alert = {
            "symbol": symbol,
            "type": alert_type,  # 'above' æˆ– 'below'
            "target_price": price,
            "message": message,
            "created_at": datetime.now(),
            "triggered": False
        }
        self.alerts.append(alert)
        
    def check(self, symbol, current_price):
        """æ£€æŸ¥æ˜¯å¦è§¦å‘é¢„è­¦"""
        triggered = []
        for alert in self.alerts:
            if alert["symbol"] == symbol and not alert["triggered"]:
                if alert["type"] == "above" and current_price >= alert["target_price"]:
                    alert["triggered"] = True
                    triggered.append(alert)
                elif alert["type"] == "below" and current_price <= alert["target_price"]:
                    alert["triggered"] = True
                    triggered.append(alert)
        return triggered
    
    def get_active_alerts(self):
        """è·å–æ´»è·ƒé¢„è­¦"""
        return [a for a in self.alerts if not a["triggered"]]
    
    def get_triggered_alerts(self):
        """è·å–å·²è§¦å‘é¢„è­¦"""
        return [a for a in self.alerts if a["triggered"]]

# ä½¿ç”¨ç¤ºä¾‹
alert_system = PriceAlert()
alert_system.add_alert("600519", "above", 2000, "èŒ…å°æ¶¨ç ´ 2000 å…ƒ")
alert_system.add_alert("600519", "below", 1500, "èŒ…å°è·Œç ´ 1500 å…ƒ")
```

### 3.2 é¢„è­¦é¢æ¿

```python
import streamlit as st
import pandas as pd
from datetime import datetime

# é¢„è­¦ç®¡ç†ç³»ç»Ÿ
if 'alerts' not in st.session_state:
    st.session_state.alerts = []

def add_alert(symbol, alert_type, price, message):
    st.session_state.alerts.append({
        "symbol": symbol,
        "type": alert_type,
        "price": price,
        "message": message,
        "created_at": datetime.now().strftime("%Y-%m-%d %H:%M"),
        "status": "æ´»è·ƒ"
    })

def delete_alert(index):
    st.session_state.alerts.pop(index)

st.title("ğŸ”” é¢„è­¦ç®¡ç†")

# æ·»åŠ é¢„è­¦
with st.expander("æ·»åŠ æ–°é¢„è­¦"):
    col1, col2, col3 = st.columns(3)
    with col1:
        new_symbol = st.text_input("è‚¡ç¥¨ä»£ç ", "600519")
    with col2:
        new_type = st.selectbox("é¢„è­¦ç±»å‹", ["æ¶¨ç ´", "è·Œç ´"])
    with col3:
        new_price = st.number_input("ç›®æ ‡ä»·æ ¼", value=100.0)
    
    new_message = st.text_input("å¤‡æ³¨", "")
    
    if st.button("æ·»åŠ é¢„è­¦"):
        add_alert(new_symbol, new_type, new_price, new_message)
        st.success("é¢„è­¦æ·»åŠ æˆåŠŸï¼")

# æ˜¾ç¤ºé¢„è­¦åˆ—è¡¨
if len(st.session_state.alerts) > 0:
    alerts_df = pd.DataFrame(st.session_state.alerts)
    
    # çŠ¶æ€ç­›é€‰
    status_filter = st.selectbox("çŠ¶æ€ç­›é€‰", ["å…¨éƒ¨", "æ´»è·ƒ", "å·²è§¦å‘"])
    if status_filter != "å…¨éƒ¨":
        alerts_df = alerts_df[alerts_df["status"] == status_filter]
    
    # æ˜¾ç¤ºé¢„è­¦
    for i, row in alerts_df.iterrows():
        col1, col2, col3, col4 = st.columns([2, 2, 3, 1])
        with col1:
            st.write(f"**{row['symbol']}**")
        with col2:
            color = "green" if row['type'] == 'æ¶¨ç ´' else 'red'
            st.markdown(f"<span style='color:{color}'>{row['type']} Â¥{row['price']}</span>", unsafe_allow_html=True)
        with col3:
            st.caption(row['message'])
        with col4:
            if st.button("åˆ é™¤", key=f"del_{i}"):
                delete_alert(i)
                st.rerun()
else:
    st.info("æš‚æ— é¢„è­¦ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ ")
```

---

## å››ã€ç»¼åˆ Dashboard

### 4.1 å®Œæ•´ Dashboard

```python
import streamlit as st
import pandas as pd
import numpy as np
import akshare as ak
import yfinance as yf
import plotly.graph_objects as go
from plotly.subplots import make_subplots
from datetime import datetime, timedelta
import time

# è®¾ç½®é¡µé¢
st.set_page_config(
    page_title="æŠ•èµ„ç›‘æ§ä¸­å¿ƒ",
    layout="wide",
    page_icon="ğŸ“ˆ"
)

# æ ‡é¢˜
st.title("ğŸ¯ æŠ•èµ„ç›‘æ§ä¸­å¿ƒ")
st.markdown("---")

# ä¾§è¾¹æ è®¾ç½®
st.sidebar.header("è®¾ç½®")

# è‚¡ç¥¨é€‰æ‹©
stocks = {
    "è´µå·èŒ…å°": {"code": "600519", "type": "A"},
    "å¹³å®‰é“¶è¡Œ": {"code": "000001", "type": "A"},
    "æ‹›å•†é“¶è¡Œ": {"code": "600036", "type": "A"},
    "å°ç§¯ç”µ": {"code": "TSM", "type": "US"}
}

selected_stock = st.sidebar.selectbox("é€‰æ‹©è‚¡ç¥¨", list(stocks.keys()))
stock_info = stocks[selected_stock]

# åˆ·æ–°é—´éš”
refresh_rate = st.sidebar.slider("åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰", 5, 300, 30)

# ç›‘æ§é€‰é¡¹
st.sidebar.subheader("ç›‘æ§é€‰é¡¹")
show_kline = st.sidebar.checkbox("K çº¿å›¾", value=True)
show_indicator = st.sidebar.checkbox("æŠ€æœ¯æŒ‡æ ‡", value=True)
show_volume = st.sidebar.checkbox("æˆäº¤é‡", value=True)

# ä¸»å†…å®¹åŒº
col_main, col_side = st.columns([3, 1])

with col_main:
    # è·å–å®æ—¶æ•°æ®
    if stock_info["type"] == "A":
        df = ak.stock_zh_a_hist(
            symbol=stock_info["code"], 
            period="daily", 
            start_date=(datetime.now() - timedelta(days=180)).strftime('%Y%m%d'),
            end_date=datetime.now().strftime('%Y%m%d')
        )
        df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'])
    else:
        data = yf.Ticker(stock_info["code"])
        df = data.history(period="1y")
        df.index.name = 'æ—¥æœŸ'
        df = df.reset_index()
        df['æ—¥æœŸ'] = pd.to_datetime(df['Date']).dt.date
        df.columns = ['æ—¥æœŸ', 'å¼€ç›˜', 'æ”¶ç›˜', 'æœ€é«˜', 'æœ€ä½', 'æˆäº¤é‡', 'Dividends', 'Stock Splits']
    
    # æœ€æ–°æ•°æ®
    latest = df.iloc[-1]
    prev = df.iloc[-2] if len(df) > 1 else latest
    
    # ä»·æ ¼ä¿¡æ¯
    price = latest['æ”¶ç›˜']
    change = ((price - prev['æ”¶ç›˜']) / prev['æ”¶ç›˜']) * 100
    
    # æ˜¾ç¤ºå…³é”®æŒ‡æ ‡
    m1, m2, m3, m4 = st.columns(4)
    m1.metric(
        selected_stock, 
        f"Â¥{price:.2f}" if stock_info["type"] == "A" else f"${price:.2f}",
        f"{change:.2f}%"
    )
    m2.metric("æœ€é«˜", f"Â¥{latest['æœ€é«˜']:.2f}" if stock_info["type"] == "A" else f"${latest['æœ€é«˜']:.2f}")
    m3.metric("æœ€ä½", f"Â¥{latest['æœ€ä½']:.2f}" if stock_info["type"] == "A" else f"${latest['æœ€ä½']:.2f}")
    m4.metric("æˆäº¤é‡", f"{latest['æˆäº¤é‡']/1e6:.2f}M")
    
    # K çº¿å›¾
    if show_kline:
        st.subheader("K çº¿å›¾")
        
        fig = make_subplots(rows=2, cols=1, shared_xaxes=True,
                           vertical_spacing=0.05,
                           subplot_titles=('K çº¿', 'æˆäº¤é‡'),
                           height=600)
        
        # K çº¿
        fig.add_trace(go.Candlestick(
            x=df['æ—¥æœŸ'],
            open=df['å¼€ç›˜'],
            high=df['æœ€é«˜'],
            low=df['æœ€ä½'],
            close=df['æ”¶ç›˜'],
            name='K çº¿',
            increasing_line_color='red',
            decreasing_line_color='green'
        ), row=1, col=1)
        
        # å‡çº¿
        df['MA5'] = df['æ”¶ç›˜'].rolling(5).mean()
        df['MA20'] = df['æ”¶ç›˜'].rolling(20).mean()
        df['MA60'] = df['æ”¶ç›˜'].rolling(60).mean()
        
        fig.add_trace(go.Scatter(x=df['æ—¥æœŸ'], y=df['MA5'], name='MA5', line=dict(color='orange', width=1)), row=1, col=1)
        fig.add_trace(go.Scatter(x=df['æ—¥æœŸ'], y=df['MA20'], name='MA20', line=dict(color='blue', width=1)), row=1, col=1)
        fig.add_trace(go.Scatter(x=df['æ—¥æœŸ'], y=df['MA60'], name='MA60', line=dict(color='purple', width=1)), row=1, col=1)
        
        # æˆäº¤é‡
        if show_volume:
            colors = ['red' if df['æ”¶ç›˜'].iloc[i] >= df['å¼€ç›˜'].iloc[i] else 'green' for i in range(len(df))]
            fig.add_trace(go.Bar(x=df['æ—¥æœŸ'], y=df['æˆäº¤é‡'], name='æˆäº¤é‡', marker_color=colors), row=2, col=1)
        
        fig.update_layout(
            xaxis_rangeslider_visible=False,
            height=650,
            showlegend=True
        )
        
        st.plotly_chart(fig, use_container_width=True)
    
    # æŠ€æœ¯æŒ‡æ ‡
    if show_indicator:
        st.subheader("æŠ€æœ¯æŒ‡æ ‡")
        
        # RSI
        delta = df['æ”¶ç›˜'].diff()
        gain = delta.where(delta > 0, 0).rolling(14).mean()
        loss = (-delta.where(delta < 0, 0)).rolling(14).mean()
        rs = gain / loss
        df['RSI'] = 100 - (100 / (1 + rs))
        
        # MACD
        ema12 = df['æ”¶ç›˜'].ewm(span=12, adjust=False).mean()
        ema26 = df['æ”¶ç›˜'].ewm(span=26, adjust=False).mean()
        df['MACD'] = ema12 - ema26
        df['Signal'] = df['MACD'].ewm(span=9, adjust=False).mean()
        df['MACD_Hist'] = df['MACD'] - df['Signal']
        
        # ç»‘åˆ¶ RSI
        fig_rsi = go.Figure()
        fig_rsi.add_trace(go.Scatter(x=df['æ—¥æœŸ'], y=df['RSI'], name='RSI', line=dict(color='purple', width=1)))
        fig_rsi.add_hline(y=70, line_dash="dash", line_color="red", annotation_text="è¶…ä¹°")
        fig_rsi.add_hline(y=30, line_dash="dash", line_color="green", annotation_text="è¶…å–")
        fig_rsi.update_layout(title="RSI (14)", height=250, yaxis_range=[0, 100])
        
        st.plotly_chart(fig_rsi, use_container_width=True)

with col_side:
    # å¿«æ·æ“ä½œ
    st.subheader("å¿«æ·æ“ä½œ")
    
    if st.button("åˆ·æ–°æ•°æ®"):
        st.rerun()
    
    if st.button("æ·»åŠ è‡ªé€‰"):
        st.success(f"{selected_stock} å·²æ·»åŠ ")
    
    # é¢„è­¦è®¾ç½®
    st.subheader("ä»·æ ¼é¢„è­¦")
    alert_price = st.number_input("é¢„è­¦ä»·æ ¼", value=float(price))
    alert_type = st.selectbox("é¢„è­¦ç±»å‹", ["æ¶¨ç ´", "è·Œç ´"])
    
    if st.button("è®¾ç½®é¢„è­¦"):
        st.success(f"å·²è®¾ç½® {selected_stock} {alert_type} Â¥{alert_price}")
    
    # ç›¸å…³ä¿¡æ¯
    st.subheader("ç›¸å…³ä¿¡æ¯")
    st.info(f"ä»£ç : {stock_info['code']}")
    st.info(f"ç±»å‹: {'A è‚¡' if stock_info['type'] == 'A' else 'ç¾è‚¡'}")

# è‡ªåŠ¨åˆ·æ–°
if refresh_rate > 0:
    time.sleep(refresh_rate)
    st.rerun()
```

---

## äº”ã€å­¦ä¹ è¦ç‚¹æ€»ç»“

### 5.1 ç›‘æ§é¢æ¿è¦ç´ 

| è¦ç´  | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|----------|
| **å®æ—¶æ•°æ®** | è‚¡ç¥¨ä»·æ ¼ã€æ¶¨è·Œå¹… | akshareã€yfinance |
| **K çº¿å›¾** | æŠ€æœ¯åˆ†æå›¾ | plotly |
| **ç»„åˆç›‘æ§** | æŒä»“ä»·å€¼ã€ç›ˆäº | pandas |
| **é¢„è­¦æœºåˆ¶** | ä»·æ ¼é¢„è­¦ã€æ¶ˆæ¯æ¨é€ | è‡ªå®šä¹‰ç±» |
| **è‡ªåŠ¨åˆ·æ–°** | å®šæ—¶æ›´æ–° | streamlit rerun |

### 5.2 æŠ€æœ¯æ ˆé€‰æ‹©

| ç»„ä»¶ | æ¨èå·¥å…· | ä¼˜ç‚¹ |
|------|----------|------|
| **å‰ç«¯å±•ç¤º** | Streamlit | ç®€å•ã€å¿«é€Ÿ |
| **äº¤äº’å›¾è¡¨** | Plotly | äº¤äº’ã€æ¼‚äº® |
| **æ•°æ®è·å–** | akshare | å…è´¹ã€ä¸°å¯Œ |
| **å®æ—¶æ€§** | å®šæ—¶åˆ·æ–° | ç®€å•æœ‰æ•ˆ |

### 5.3 æœ€ä½³å®è·µ

1. **åˆç†åˆ·æ–°é¢‘ç‡**ï¼šå¹³è¡¡å®æ—¶æ€§å’ŒæœåŠ¡å™¨å‹åŠ›
2. **æ•°æ®ç¼“å­˜**ï¼šé¿å…é‡å¤è¯·æ±‚
3. **é”™è¯¯å¤„ç†**ï¼šå¤„ç†ç½‘ç»œå¼‚å¸¸
4. **ç”¨æˆ·å‹å¥½**ï¼šæ¸…æ™°çš„ç•Œé¢è®¾è®¡

---

## å…­ã€å»¶ä¼¸å­¦ä¹ 

### 6.1 æ¨èç ”ç©¶

1. Streamlit é«˜çº§ç»„ä»¶
2. Dash æ¡†æ¶
3. WebSocket å®æ—¶æ•°æ®
4. æ•°æ®åº“å­˜å‚¨

### 6.2 å¾…å®è·µ

1. éƒ¨ç½²åˆ°äº‘ç«¯
2. æ·»åŠ ç”¨æˆ·è®¤è¯
3. å®ç°å¤šç”¨æˆ·
4. æ·»åŠ å›æµ‹åŠŸèƒ½

---

*æœ¬å­¦ä¹ ç¬”è®°ç”± Clawdbot è‡ªä¸»å­¦ä¹ æ•´ç†*
*ç‰ˆæœ¬ï¼š1.0 | 2026-02-03*
